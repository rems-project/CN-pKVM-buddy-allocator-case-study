# pKVM buddy allocator case study

This repository contains a case study in C code verification using the
CN type system: the buddy allocator of the pKVM hypervisor for
Android.

The original files in the version we verified can be found in the [android-kvm repositories](https://android-kvm.googlesource.com/linux/+/39111fc40453747f8213cf9ef4337448d3c6197d/arch/arm64/kvm/hyp/nvhe/page_alloc.c).

Each file has a comment recording the original source code location in
the Linux source tree, retaining the original license/copyright
headers. Comments in the files point out where the code has been
modified (minor edits and additions).

The directory contains the license file `GPL-2.0` and the note
`Linux-syscall-note`.



The directory structure is as follows:

- [page_alloc.c](page_alloc.c) contains the main body of the buddy
  allocator code. The function `__hyp_attach_page` discussed in the
  paper and its annotations can be found here.

- [gfp.h](gfp.h) defines the buddy allocator API described in the
  paper.

- [memory.h](memory.h) contains a number of auxiliary definitions of
  functions and types.
  
- [defs.h](defs.h) defines resource predicates and logical functions,
  including the main invariant, `Hyp_pool`; it also declares
  uninterpreted functions used in the proof.

- [lemmas.h](lemmas.h) states lemmas.

- [coq_lemmas](coq_lemmas) is the directory for the Coq part of the verification:

  - [theories/Gen_Spec.v](coq_lemmas/theories/Gen_Spec.v) contains the
    lemma statements generated by CN,
  
  - [theories/Buddy_Aligned.v](coq_lemmas/theories/Buddy_Aligned.v)
    proofs about alignment and 'buddy' as specification concepts,

  - [theories/Pages_Aligned.v](coq_lemmas/theories/Pages_Aligned.v)
    proofs about invariants of this buddy allocator formalisation,

  - [theories/Inst_Spec.v](coq_lemmas/theories/Inst_Spec.v) the
    instantiation of the Coq module specifications in `Gen_Spec.v`.

  This Coq development has been checked with Coq 8.15.0.


- other `*.h`: these are various dependencies of the buddy allocator
  from the linux source tree.
